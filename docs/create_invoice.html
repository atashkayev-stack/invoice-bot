<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rechnung erstellen</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
    // 1. –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const encodedData = urlParams.get('data');

        if (encodedData) {
            try {
                // 2. –î–µ–∫–æ–¥–∏—Ä—É–µ–º Base64 –∏ –ø–∞—Ä—Å–∏–º –≤ JSON
                // decodeURIComponent –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å %20 –∏ –ø—Ä–æ—á–∏–µ —Å–∏–º–≤–æ–ª—ã –∏–∑ URL
                const jsonString = atob(decodeURIComponent(encodedData));
                const data = JSON.parse(jsonString);

                console.log("–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:", data);

                // 3. –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã (—É–±–µ–¥–∏—Å—å, —á—Ç–æ ID —Å–æ–≤–ø–∞–¥–∞—é—Ç!)
                if (data.company_name) document.getElementById('company_name').value = data.company_name;
                if (data.street) document.getElementById('street').value = data.street;
                if (data.postal_code) document.getElementById('postal_code').value = data.postal_code;
                if (data.city) document.getElementById('city').value = data.city;
                if (data.tax_id) document.getElementById('tax_id').value = data.tax_id;
                if (data.iban) document.getElementById('iban').value = data.iban;

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö:", e);
            }
        }
    };

    // 4. –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞—Ç–Ω–æ –≤ –±–æ—Ç (–∫–æ–≥–¥–∞ –Ω–∞–∂–º–µ—à—å "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å")
    function sendDataBack() {
        const tg = window.Telegram.WebApp;
        const resultData = {
            company_name: document.getElementById('company_name').value,
            // ... —Å–æ–±—Ä–∞—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è ...
        };
        
        tg.sendData(JSON.stringify(resultData));
        tg.close();
    }
</script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 15px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .form-control, .form-select {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
            border: 1px solid var(--tg-theme-hint-color, #999999);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 10px;
        }
        .form-label {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-color, #0088cc);
        }
        .btn-primary {
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-weight: 600;
            width: 100%;
            margin-top: 15px;
        }
        .info-text {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            margin-top: -8px;
            margin-bottom: 10px;
        }
        .required::after {
            content: " *";
            color: #ff3b30;
        }
        .ai-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        .calculated-field {
            background: var(--tg-theme-secondary-bg-color, #e8f5e9);
            font-weight: 600;
            font-size: 18px;
            padding: 12px;
            text-align: right;
        }
        .input-group-text {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border: 1px solid var(--tg-theme-hint-color, #999999);
        }
    </style>
</head>
<body>
    <div class="container">
        <h4 style="margin-bottom: 20px;">üìù Neue Rechnung</h4>
        
        <div id="aiNotice" class="alert alert-info" style="display: none; padding: 10px; font-size: 13px; border-radius: 8px;">
            <strong>ü§ñ KI-erkannte Daten</strong><br>
            Diese Felder wurden automatisch ausgef√ºllt. Bitte √ºberpr√ºfe sie!
        </div>
        
        <form id="invoiceForm">
            <!-- Kundendaten -->
            <div class="section-title">
                üë§ Kundendaten
                <span id="aiExtractedBadge" class="ai-badge" style="display: none;">KI erkannt</span>
            </div>
            
            <div class="mb-3">
                <label class="form-label required">Kundenname / Firma</label>
                <input type="text" class="form-control" id="client_name" 
                       placeholder="z.B. Musterfirma GmbH" required>
            </div>
            
            <div class="mb-3">
                <label class="form-label required">Vollst√§ndige Adresse</label>
                <textarea class="form-control" id="client_address" rows="3" 
                          placeholder="Stra√üe Nr., PLZ Ort, Land" required></textarea>
            </div>
            
            <div class="mb-3">
                <label class="form-label">E-Mail</label>
                <input type="email" class="form-control" id="client_email" 
                       placeholder="kunde@firma.de">
            </div>
            
            <div class="mb-3">
                <label class="form-label">Telefon</label>
                <input type="tel" class="form-control" id="client_phone" 
                       placeholder="+49 30 12345678">
            </div>
            
            <div class="mb-3">
                <label class="form-label">Steuernummer</label>
                <input type="text" class="form-control" id="client_tax_id" 
                       placeholder="123/456/78901">
            </div>
            
            <div class="mb-3">
                <label class="form-label">USt-ID</label>
                <input type="text" class="form-control" id="client_vat_id" 
                       placeholder="DE123456789">
            </div>
            
            <!-- Rechnungsdaten -->
            <div class="section-title">üìã Rechnungsdetails</div>
            
            <div class="mb-3">
                <label class="form-label required">Rechnungsdatum</label>
                <input type="date" class="form-control" id="invoice_date" required>
            </div>
            
            <div class="mb-3">
                <label class="form-label required">Leistungsbeschreibung</label>
                <textarea class="form-control" id="description" rows="4" 
                          placeholder="z.B. Website-Entwicklung inkl. Design und Programmierung" required></textarea>
                <div class="info-text">Was wurde geleistet?</div>
            </div>
            
            <!-- Betrag und MwSt -->
            <div class="section-title">üí∞ Betrag</div>
            
            <div class="mb-3">
                <label class="form-label required">Nettobetrag</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="amount" 
                           step="0.01" min="0.01" placeholder="0.00" required>
                    <span class="input-group-text">‚Ç¨</span>
                </div>
                <div class="info-text">Betrag ohne Mehrwertsteuer</div>
            </div>
            
            <div class="mb-3">
                <label class="form-label required">Mehrwertsteuersatz</label>
                <select class="form-select" id="vat_rate" required>
                    <option value="19">19% (Standard)</option>
                    <option value="7">7% (erm√§√üigt)</option>
                    <option value="0">0% (Kleinunternehmer / ¬ß19 UStG)</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-label">MwSt.-Betrag</label>
                <div class="form-control calculated-field" id="vat_amount_display">0,00 ‚Ç¨</div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Gesamtbetrag (Brutto)</label>
                <div class="form-control calculated-field" id="total_display" 
                     style="font-size: 20px; background: #e3f2fd;">0,00 ‚Ç¨</div>
            </div>
            
            <!-- Zahlungsbedingungen -->
            <div class="section-title">üìÖ Zahlungsbedingungen</div>
            
            <div class="mb-3">
                <label class="form-label">Zahlungsziel (Tage)</label>
                <input type="number" class="form-control" id="payment_terms" 
                       value="14" min="1" max="90">
                <div class="info-text">Frist bis zur Zahlung</div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Zus√§tzliche Hinweise (optional)</label>
                <textarea class="form-control" id="notes" rows="2" 
                          placeholder="z.B. Vielen Dank f√ºr Ihren Auftrag!"></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary">
                ‚úÖ Rechnung erstellen
            </button>
        </form>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.hide();

        // –°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.getElementById('invoice_date').valueAsDate = new Date();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç AI
        const urlParams = new URLSearchParams(window.location.search);
        const dataParam = urlParams.get('data');
        
        if (dataParam) {
            try {
                const decodedData = atob(decodeURIComponent(dataParam));
                const aiData = JSON.parse(decodedData);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–µ–π–¥–∂ —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ—Ç AI
                document.getElementById('aiExtractedBadge').style.display = 'inline-block';
                document.getElementById('aiNotice').style.display = 'block';
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è
                if (aiData.company_name) document.getElementById('client_name').value = aiData.company_name;
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –∞–¥—Ä–µ—Å
                let addressParts = [];
                if (aiData.street) addressParts.push(aiData.street);
                if (aiData.postal_code && aiData.city) {
                    addressParts.push(aiData.postal_code + ' ' + aiData.city);
                }
                if (aiData.country) addressParts.push(aiData.country);
                
                if (addressParts.length > 0) {
                    document.getElementById('client_address').value = addressParts.join('\n');
                }
                
                if (aiData.email) document.getElementById('client_email').value = aiData.email;
                if (aiData.phone) document.getElementById('client_phone').value = aiData.phone;
                if (aiData.tax_id) document.getElementById('client_tax_id').value = aiData.tax_id;
                if (aiData.vat_id) document.getElementById('client_vat_id').value = aiData.vat_id;
                
            } catch (error) {
                console.error('Error parsing AI data:', error);
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç MwSt –∏ –ò—Ç–æ–≥–æ
        function calculateTotals() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const vatRate = parseFloat(document.getElementById('vat_rate').value) || 0;
            
            const vatAmount = amount * (vatRate / 100);
            const total = amount + vatAmount;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            document.getElementById('vat_amount_display').textContent = 
                vatAmount.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
            
            document.getElementById('total_display').textContent = 
                total.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
            
            return { vatAmount, total };
        }
        
        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É–º–º—ã –∏ –ù–î–°
        document.getElementById('amount').addEventListener('input', calculateTotals);
        document.getElementById('vat_rate').addEventListener('change', calculateTotals);
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
        document.getElementById('invoiceForm').onsubmit = (e) => {
            e.preventDefault();
            
            const { vatAmount, total } = calculateTotals();
            
            const invoiceData = {
                // –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
                client_name: document.getElementById('client_name').value,
                client_address: document.getElementById('client_address').value,
                client_email: document.getElementById('client_email').value || null,
                client_phone: document.getElementById('client_phone').value || null,
                client_tax_id: document.getElementById('client_tax_id').value || null,
                client_vat_id: document.getElementById('client_vat_id').value || null,
                
                // –î–∞–Ω–Ω—ã–µ —Å—á–µ—Ç–∞
                date: document.getElementById('invoice_date').value,
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                vat_rate: parseFloat(document.getElementById('vat_rate').value),
                vat_amount: vatAmount,
                total: total,
                payment_terms: parseInt(document.getElementById('payment_terms').value),
                notes: document.getElementById('notes').value || null
            };
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ –±–æ—Ç
            const data = {
                invoice_data: invoiceData
            };
            
            tg.sendData(JSON.stringify(data));
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞—Å—á–µ—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        calculateTotals();
    </script>
</body>
</html>
